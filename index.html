<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ“š PDF æ•™æå¹³å°</title>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 20px; background: #f0f0f0; }
    h1 { color: #333; }
    .container { display: flex; gap: 20px; }
    .sidebar { width: 260px; }
    select { width: 100%; font-size: 18px; height: 400px; }
    button { padding: 8px 12px; font-size: 16px; margin: 5px 0; width: 100%; }
    .back-btn { background-color: #eee; border: 1px solid #aaa; border-radius: 4px; }
    canvas { width: 100%; border: 1px solid #ccc; background: #fff; }
    .status { margin-top: 10px; font-weight: bold; font-size: 18px; }
    #stats { margin-top: 10px; font-size: 18px; display: flex; align-items: center; gap: 16px; white-space: nowrap; }
    .stat-block { min-width: 140px; }
    #likeBtn { width: 40px; height: 40px; font-size: 20px; padding: 0; border-radius: 6px; border: 1px solid #aaa; background-color: #fff; cursor: pointer; }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.9.179/pdf.min.js"></script>
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.9.179/pdf.worker.min.js';
  </script>
</head>
<body>
  <h1>ğŸ“„ PDF æ•™ææ¸…å–®</h1>
  <div class="container">
    <div class="sidebar">
      <select id="pdfSelect" size="10"></select>
      <button onclick="prevPDF()">â¬…ï¸ ä¸Šä¸€é …</button>
      <button onclick="nextPDF()">â¡ï¸ ä¸‹ä¸€é …</button>
      <button class="back-btn" onclick="goBack()">ğŸ”™ è¿”å›ä¸»é </button>
    </div>
    <div style="flex: 1;">
      <canvas id="pdfCanvas"></canvas>
      <div class="status" id="statusText">å°šæœªé¸æ“‡ PDF</div>
      <div id="stats">
        <div class="stat-block">ğŸ‘ï¸ é»é–±ï¼š<span id="viewCount">00000</span></div>
        <div class="stat-block">ğŸ‘ æŒ‰è®šï¼š<span id="likeCount">00000</span></div>
        <button id="likeBtn" onclick="likePDF()">ğŸ‘</button>
      </div>
    </div>
  </div>

  <script>
    const manifestURL = './data/manifest.json';
    let pdfList = [];
    let currentIndex = -1;

    async function loadPDFList() {
      try {
        const res = await fetch(manifestURL);
        const data = await res.json();
        if (!Array.isArray(data)) throw new Error('manifest.json æ‡‰ç‚ºé™£åˆ—æ ¼å¼');
        pdfList = data;

        const select = document.getElementById('pdfSelect');
        select.innerHTML = '';
        pdfList.forEach((item, index) => {
          const option = document.createElement('option');
          option.value = index;
          option.textContent = item.title;
          select.appendChild(option);
        });

        if (pdfList.length > 0) showPDF(0);
      } catch (err) {
        console.error('è¼‰å…¥éŒ¯èª¤ï¼š', err);
        document.getElementById('statusText').textContent = 'âŒ ç„¡æ³•è¼‰å…¥ PDF æ¸…å–®';
      }
    }

    function showPDF(index) {
      if (index < 0 || index >= pdfList.length) return;
      currentIndex = index;
      pdfList[index].views = (pdfList[index].views || 0) + 1;

      const fileURL = pdfList[index].url;
      const canvas = document.getElementById('pdfCanvas');
      const context = canvas.getContext('2d');

      document.getElementById('statusText').textContent = 'â³ è¼‰å…¥ä¸­â€¦';

      pdfjsLib.getDocument(fileURL).promise.then(pdf => {
        return pdf.getPage(1);
      }).then(page => {
        const scale = 1.5;
        const viewport = page.getViewport({ scale });
        canvas.height = viewport.height;
        canvas.width = viewport.width;

        const renderContext = {
          canvasContext: context,
          viewport: viewport
        };
        page.render(renderContext);
        document.getElementById('statusText').textContent =
          `ğŸ“˜ ç¬¬ ${index + 1} é … / å…± ${pdfList.length} é …ï¼š${pdfList[index].title}`;
      }).catch(err => {
        console.error('PDF è¼‰å…¥å¤±æ•—ï¼š', err.message);
        document.getElementById('statusText').textContent = 'âŒ ç„¡æ³•é¡¯ç¤º PDFï¼š' + err.message;
      });

      document.getElementById('pdfSelect').value = index;
      updateStats(index);
    }

    function updateStats(index) {
      const item = pdfList[index];
      document.getElementById('viewCount').textContent =
        String(item.views || 0).padStart(5, '0');
      document.getElementById('likeCount').textContent =
        String(item.likes || 0).padStart(5, '0');
    }

    function prevPDF() {
      if (currentIndex > 0) showPDF(currentIndex - 1);
    }

    function nextPDF() {
      if (currentIndex < pdfList.length - 1) showPDF(currentIndex + 1);
    }

    function likePDF() {
      if (currentIndex >= 0) {
        pdfList[currentIndex].likes = (pdfList[currentIndex].likes || 0) + 1;
        updateStats(currentIndex);
      }
    }

    function goBack() {
      window.location.href = './'; // è¿”å›æ ¹ç›®éŒ„æˆ–é¦–é 
    }

    document.getElementById('pdfSelect').addEventListener('change', function () {
      const index = parseInt(this.value);
      if (!isNaN(index)) showPDF(index);
    });

    loadPDFList();
  </script>
</body>
</html>
